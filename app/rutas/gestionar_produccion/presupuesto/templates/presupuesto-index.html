{% extends 'base.html' %}

{% block titulo %}
Presupuestos
{% endblock %}

{% block contenido %}
<div class="container mt-4">
  <h3>Listar Presupuestos</h3>

  <!-- tarjeta -->
  <div class="card">
    <div class="card-header">
      <button type="button" class="btn btn-primary" id="btnAgregar">Agregar</button>
    </div>
    <div class="card-body">
      <div class="table-responsive" style="max-height: 500px; overflow-y: auto; overflow-x: auto;">
        <table class="table table-striped" id="tbl">
          <thead>
            <tr>
              <th>ID Presupuesto</th>
              <th>Cliente</th>
              <th>CI</th>
              <th>Estado</th>
              <th>Fecha de creación</th>
              <th>Fecha Solicitud</th>
              <th>Fecha Estado</th>
              <th>Total</th>
              <th>Gestionar</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- /tarjeta -->

  <!-- El formulario -->
  <div class="modal" id="modalFormulario">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title" id="modalTitle"></h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          <div class="form-group">
            <input type="hidden" id="txtidpresupuesto">
            <label for="txtCliente">Cliente:</label>
            <input type="hidden" id="txtIdCliente">
            <input type="text" class="form-control" placeholder="click para buscar Cliente" id="txtCliente" readonly>
            <label for="txtDescripcion">Asignar Prendas</label>
            <div class="form-row">
              <input type="hidden" id="txtIdcosto">
              <input type="text" class="form-control" placeholder="Buscar Prendas" id="txtcosto" readonly
                style="width: 350px;">
              <button type="button" class="btn btn-success" id="cargarmp">Cargar</button>
            </div>
            <label for="txtDescripcion">Prendas seleccionadas:</label>
            <div class="table-responsive" style="max-height: 200px; overflow-y: auto; overflow-x: auto;">
              <table class="table table-striped" id="detalles">
                <thead>
                  <tr>
                    <th>Prenda</th>
                    <th>Costo</th>
                    <th>ELIMINAR</th>
                  </tr>
                </thead>
                <tbody>

                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Modal footer -->
        <div class="modal-footer d-flex justify-content-between align-items-center">
          <div>
            <strong>Total:</strong>
            <span id="totalGeneralFooter" style="font-size:1.2em;">0</span>
          </div>
          <div>
            <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
            <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
          </div>
        </div>

      </div>
    </div>
  </div>
  <!-- buscar datos cliente -->
  <div class="modal" id="modalFormulariob">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal2Title"></h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblb">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>CI</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- modal de gestion de presupuestos -->
  <div class="modal" id="modalFormulariog">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modalTitleg">Gestionar Presupuesto</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <input type="hidden" id="txtidpresupuestog">
            <label for="txtClienteg">Cliente:</label>
            <input type="hidden" id="txtIdClienteg">
            <input type="text" class="form-control" id="txtClienteg" readonly>
            <button type="button" class="btn btn-success my-2" id="btnAgregarDetalleG">Agregar Prenda</button>
            <div class="table-responsive" style="max-height: 200px; overflow-y: auto; overflow-x: auto;">
              <table class="table table-striped" id="detallesg">
                <thead>
                  <tr>
                    <th>Prenda</th>
                    <th>Costo</th>
                    <th>Eliminar</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- Modal footer -->
        <div class="modal-footer d-flex justify-content-between align-items-center">
          <div>
            <strong>Total:</strong>
            <span id="totalGestionFooter" style="font-size:1.2em;">0</span>
          </div>
          <div>
            <button type="button" class="btn btn-success" id="btnAprobar">Aprobar</button>
            <button type="button" class="btn btn-warning d-none" id="btnModificar">Modificar</button>
            <button type="button" class="btn btn-danger" id="btnAnular">Anular</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- buscar datos prendas(tabla costos) -->

  <div class="modal" id="modalFormularioc">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal3Title"></h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive " style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
            <table class="table table-striped table-bordered w-100" id="tblc">
              <thead>
                <tr>
                  <th>Prenda</th>
                  <th>color</th>
                  <th>Consulta Disponibilidad</th> <!-- boton al modal de verificación -->
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- modal para verificar si hay materias primas suficientes para la prenda -->

  <div class="modal" id="modalFormulariod">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal4Title"></h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div>
            <input type="hidden" id="disponible" value="1">
            <input type="hidden" id="txtIdconsulta">
            <input type="text" class="form-control" readonly value="" id="txtnprenda">
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblm">
              <thead>
                <tr>
                  <th>Materia prima necesaria</th>
                  <th>Unidad de medida</th>
                  <th>Necesaria</th>
                  <th>En stock</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="btnAsignarp">Asignar</button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!--modal para agregar mp extra  -->
  <div class="modal" id="modalFormulariomp">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modalTitlemp"></h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="txtDescripcion">Materias primas:</label>
            <div class="form-row">
              <input type="hidden" id="txtIdMateria_prima">
              <input type="hidden" id="txtstockmp">
              <input type="text" class="form-control" placeholder="buscar Materia Prima" id="txtmateria_prima" readonly
                style="width: 200px;">
              <input type="number" class="form-control" placeholder="Cantidad" id="txtCantidad" style="width: 100px;"
                min="1">
              <button type="button" class="btn btn-success" id="cargarmpe">Cargar</button>
            </div>
            <label for="txtDescripcion">Materias primas seleccionadas:</label>
            <div class="table-responsive" style="max-height: 200px; overflow-y: auto; overflow-x: auto;">
              <table class="table table-striped" id="detallesmpe">
                <thead>
                  <tr>
                    <th>NOMBRE</th>
                    <th>CANTIDAD</th>
                    <th>ELIMINAR</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="btnGuardarmp">Guardar</button>
          <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- tabla de mp extras -->
  <div class="modal" id="modalFormulariompe">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modalTitlempe"></h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered w-100" id="tblmpe">
              <thead>
                <tr>
                  <th>Materia Prima</th>
                  <th>color</th>
                  <th>stock</th>
                  <th>Medida</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4 d-none" id="rowAlerta">
    <div class="col col-md-12">
      <div class="alert alert-success">
        <strong>Registro Exitoso!</strong>
        <div class="row" id="mostrarAlerta"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<script>
  const estadosGlosario = {
    'P': 'Pendiente',
    'A': 'Aprobado',
    'I': 'Iniciado',
    'F': 'Finalizado',
    'R': 'Rechazado'
  };

  const getId = (row) => row.idpresupuesto ?? row.id ?? row.presupuesto_id ?? row.idorden_produccion;
  const getClienteNombre = (row) => {
    if ((row.per_nombre || row.per_apellido)) return `${row.per_nombre ?? ''} ${row.per_apellido ?? ''}`.trim();
    if (row.cliente_nombre) return row.cliente_nombre;
    if (row.cliente) return row.cliente;
    return '';
  };
  const getClienteCI = (row) => row.per_ci ?? row.ci ?? row.cliente_ci ?? '';

  const initDatatable = () => {
    $('#tbl').DataTable({
      language: {
        url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
      },
      ajax: '/api/v1/presupuestos',
      columns: [
        { data: function (row) { return row.idpresupuesto; } },
        { data: function (row) { return getClienteNombre(row); } },
        { data: function (row) { return getClienteCI(row); } },
        { data: function (row) { return estadosGlosario[row.estado] || row.estado || ''; } },
        { data: function (row) { return formatearFecha(row.fecha); } },
        { data: function (row) { return formatearFecha(row.fecha_solicitud); } },
        { data: function (row) { return formatearFecha(row.fecha_estado); } },
        { data: function (row) { return row.total ?? ''; } },
        {
          data: function (row) {
            const estado = (row.estado ?? '').toUpperCase();
            const estadosHabilitados = ["P", "MEJORABLE", "PENDIENTE"];
            const isEnabled = estadosHabilitados.includes(estado);
            const id = row.idpresupuesto;
            return `<button type="button" name="btn_editar" class="btn btn-primary" data-idpresupuesto="${id}" ${isEnabled ? "" : "disabled"}>Gestionar</button>`;
          }
        }
      ]
    });
  }

  const initDatatableb = () => {
    $('#tblb').DataTable({
      language: {
        url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
      },
      ajax: '/api/v1/clientes',
      columns: [
        { data: 'per_nombre' },
        { data: 'per_apellido' },
        { data: 'per_ci' },
        {
          data: function (row) {
            return `<button type="button" name="btn_asignar" class="btn btn-primary" data-id="${row.idcliente}" data-pnombre="${row.per_nombre}" data-papellido="${row.per_apellido}" data-pci="${row.per_ci}">
                      <i class="fa fa-check"></i> Seleccionar
                    </button>`
          }
        }
      ]
    });
    $('#tblb').on('click', 'button[name="btn_asignar"]', function () {
      const idCliente = $(this).data('id');
      const nombre = $(this).data('pnombre');
      const apellido = $(this).data('papellido');
      const ci = $(this).data('pci');
      $('#txtCliente').val(nombre + ' ' + apellido + ' ' + ci);
      $('#txtIdCliente').val(idCliente);
      $('#modalFormulariob').modal('hide');
    });
  }

  const initDatatablec = () => {
    $('#tblc').DataTable({
      language: {
        url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
      },
      ajax: '/api/v1/costos',
      columns: [
        { data: 'pro_nombre' },
        { data: 'pro_color' },
        {
          data: function (row) {
            return `<button type="button" name="btn_asignar"  class="btn btn-primary" data-id="${row.idcosto}" data-pnombre="${row.pro_nombre}" data-pcolor="${row.pro_color}" >
                      <i class="fa fa-eye"></i> Consultar
                    </button>`
          }
        }
      ]
    });
    $('#tblc').on('click', 'button[name="btn_asignar"]', function () {
      const idcosto = $(this).data('id');
      const nombre = $(this).data('pnombre');
      const color = $(this).data('pcolor');

      $('#txtnprenda').val(nombre + ' ' + color);
      $('#txtIdconsulta').val(idcosto);

      if (idcosto > 0) {
        fetch(`/api/v1/costos/${idcosto}/detalles`, { method: 'GET', headers: { 'Content-Type': 'application/json' } })
          .then(resp => {
            if (!resp.ok) throw new Error(`Error en la solicitud: ${resp.statusText}`);
            return resp.json();
          })
          .then(detallesData => {
            const detalles = detallesData.data || [];
            const table = $("#tblm tbody");
            table.empty();
            detalles.forEach(detalle => {
              const { mp_nombre, unidad, cantidad, stock } = detalle;
              const newRow = $("<tr>");
              $("<td>").text(mp_nombre).appendTo(newRow);
              $("<td>").text(unidad).appendTo(newRow);
              $("<td>").text(cantidad).appendTo(newRow);
              $("<td>").text(stock).appendTo(newRow);
              table.append(newRow);
            });
            $('#modal4Title').text("Disponibilidad de Materias Primas");
            $('#modalFormulariod').modal('show');
          })
          .catch(error => {
            console.error("Error al cargar los detalles:", error);
            alert("No se pudieron cargar los detalles. Intenta nuevamente.");
          });
      } else {
        alert("ID de costo no válido.");
      }
    });
  }

  const asignarprenda = () => {
    $('#btnAsignarp').on('click', function () {
      const a = $('#disponible').val();
      if (a > 0) {
        const idprenda = $('#txtIdconsulta').val();
        const prenda = $('#txtnprenda').val();
        $('#txtIdcosto').val(idprenda);
        $('#txtcosto').val(prenda);
        $('#modalFormulariod').modal('hide');
        $('#modalFormularioc').modal('hide');
      } else {
        Swal.fire("Error", "No hay disponibilidad de materias primas en la prenda seleccionada.", "error");
      }
    });
  }

  const initDatatablem = () => {
    $('#tblmpe').DataTable({
      language: { url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}" },
      ajax: '/api/v1/materia_primas',
      columns: [
        { data: 'mat_nombre' },
        { data: 'mat_color' },
        { data: 'mat_cantidad' },
        { data: 'mat_unidad_medida' },
        {
          data: function (row) {
            return `<button type="button" name="btn_asignarmpe" class="btn btn-primary" data-id="${row.idmateria_prima}" data-producto="${row.mat_nombre}"data-stock="${row.mat_cantidad}">
                      <i class="fa fa-check"></i> Seleccionar
                    </button>`
          }
        }
      ]
    });
    $('#tblmpe').on('click', 'button[name="btn_asignarmpe"]', function () {
      const idMateria_prima = $(this).data('id');
      const materia_prima = $(this).data('producto');
      const stock = $(this).data('stock');
      $('#txtmateria_prima').val(materia_prima);
      $('#txtIdMateria_prima').val(idMateria_prima);
      $('#txtstockmp').val(stock);
      $('#modalFormulariompe').modal('hide');
    });
  }

  const cargarDetallempe = () => {
    $("#cargarmpe").on('click', function () {
      const IdMateria_prima = $("#txtIdMateria_prima").val();
      const materia_prima = $("#txtmateria_prima").val();
      const stock = parseInt($("#txtstockmp").val());
      const cantidad = parseInt($("#txtCantidad").val(), 10) || 0;
      if (cantidad > 0 && cantidad <= stock) {
        const table = $("#detallesmpe tbody");
        const newRow = $("<tr>");
        $("<td>").text(materia_prima).appendTo(newRow);
        $("<td>").text(cantidad).appendTo(newRow);
        $("<td>").html('<button class="btn btn-link btn-delete"><i class="fa fa-trash"></i></button>').appendTo(newRow);
        $("<td>").html('<input type="hidden" id="idmp" value="' + IdMateria_prima + '">').appendTo(newRow);
        table.append(newRow);
        $("#txtmateria_prima").val('');
        $("#txtCantidad").val('');
        $("#txtstockmp").val('');
        $("#txtIdMateria_prima").val('');
        newRow.find(".fa-trash").click(function () { $(this).closest("tr").remove(); });
      } else {
        alert("La cantidad debe ser mayor a 0 y menor o igual al stock de la materia prima.");
      }
    });
  }

  const guardarmpe = () => {
    $('#btnGuardarmp').on('click', function () {
      const detalles = [];
      $("#detallesmpe tbody tr").each(function () {
        const idmp = $(this).find("input[type='hidden']").val();
        const cantidad = $(this).find("td").eq(1).text();
        if (idmp) {
          detalles.push({ idmateria_prima: idmp, dco_cantidad: cantidad });
        }
      });
      if (detalles.length === 0) {
        Swal.fire("Error", "No hay materias primas para guardar.", "error");
        return;
      }
      const dataa = { detalles: detalles };
      fetch(`/api/v1/presupuestosmp`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dataa) })
        .then(() => {
          $('#modalFormulariomp').modal('hide');
          finalizar();
        }).catch(err => {
          console.error(err);
          Swal.fire("Error", "Ocurrió un error al actualizar.", "error");
        });
    });
  }

  const buacarmat = () => {
    $('#txtmateria_prima').on('click', function () {
      $('#modalTitlempe').text("Selecciona una Materia Prima");
      $('#modalFormulariompe').modal();
    });
  }

  const finalizar = () => {
    const tabla = $('#tbl').DataTable();
    const idpresupuesto = $('#txtidpresupuestog').val();
    const accion = 'procesar';
    fetch(`/api/v1/presupuestosfin`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ idpresupuesto: idpresupuesto, accion: accion }),
    })
      .then(resp => resp.json())
      .then(data => {
        if (data.success) {
          $('#modalFormulariog').modal("hide");
          tabla.ajax.reload();
          Swal.fire("Actualizado", "El presupuesto ha sido actualizado correctamente.", "success");
        } else {
          Swal.fire(data.error || "Error desconocido");
        }
      }).catch(err => {
        console.error(err);
        Swal.fire("Error", "Ocurrió un error al actualizar.", "error");
      });
  }

  const agregar = () => {
    $('#btnAgregar').on('click', function () {
      $('#modalTitle').text("Agregar un Presupuesto");
      $('#txtidpresupuesto').val("");
      $('#txtDescripcion').val("");
      $('#modalFormulario').modal();
    });
  }

  const buacarcliente = () => {
    $('#txtCliente').on('click', function () {
      $('#modal2Title').text("Selecciona un Cliente");
      $('#modalFormulariob').modal();
    });
  }
  const buacarcosto = () => {
    $('#txtcosto').on('click', function () {
      $('#modal3Title').text("Selecciona una Prenda");
      $('#modalFormularioc').modal();
    });
  }

  const cargarDetalle = () => {
    $("#cargarmp").on('click', function () {
      const Idcosto = $("#txtIdcosto").val();
      const costo = $("#txtcosto").val();
      if (Idcosto > 0) {
        // Obtener el costo del producto desde la API
        fetch(`/api/v1/costos/${Idcosto}`, { method: 'GET', headers: { 'Content-Type': 'application/json' } })
          .then(resp => resp.json())
          .then(data => {
            // Suponiendo que el endpoint devuelve { success: true, data: { total: ... } }
            const totalProducto = data.data?.cos_total ?? 0;

            // nueva fila
            const table = $("#detalles tbody");
            const newRow = $("<tr>");
            $("<td>").text(costo).appendTo(newRow);
            $("<td>").text(totalProducto).addClass("costoProducto").appendTo(newRow);
            $("<td>").html('<button class="btn btn-link btn-delete"><i class="fa fa-trash"></i></button>').appendTo(newRow);
            $("<td>").html('<input type="hidden" id="idmp" value="' + Idcosto + '">').appendTo(newRow);
            table.append(newRow);

            // limpiar inputs
            $("#txtIdcosto").val('');
            $("#txtcosto").val('');

            newRow.find(".fa-trash").click(function () {
              const row = $(this).closest("tr");
              row.remove();
              actualizarTotalGeneral();
            });

            actualizarTotalGeneral();
          });
      }
    });
  }

  // Función para sumar el total general
  function actualizarTotalGeneral() {
    let total = 0;
    $("#detalles tbody tr").each(function () {
      const costo = parseFloat($(this).find(".costoProducto").text()) || 0;
      total += costo;
    });
    $("#totalGeneral").text(total.toFixed(2));
    $("#totalGeneralFooter").text(total.toFixed(2));
  }

  const guardar = () => {
    $('#btnGuardar').on('click', function () {
      const idPresupuesto = $('#txtidpresupuesto').val();
      const idCliente = $('#txtIdCliente').val();
      const tabla = $('#tbl').DataTable();
      const detalles = [];

      $("#detalles tbody tr").each(function () {
        const idcosto = $(this).find("input[type='hidden']").val();
        if (idcosto) {
          detalles.push({ idcosto: idcosto });
        }
      });
      const totalGeneral = parseFloat($("#totalGeneralFooter").text()) || 0;
      const dataa = {
        cliente_id: idCliente,
        detalles: detalles,
        total: totalGeneral
      };

      if (detalles.length > 0) {
        fetch(`/api/v1/presupuestos`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dataa)
        })
          .then(resp => resp.json())
          .then(data => {
            if (data && !data.error && data.success) {
              tabla.ajax.reload();
              Swal.fire("Agregado", "El presupuesto ha sido creado correctamente.", "success");
              $('#modalFormulario').modal("hide");
            } else {
              Swal.fire(data.error || "Error desconocido");
            }
          }).catch(err => {
            console.error(err);
            Swal.fire("Error", "Ocurrió un error al guardar el presupuesto.", "error");
          });
      } else {
        Swal.fire("Error", "Debe agregar al menos una prenda.", "error");
      }
    });
  }
  const enviarArevision = () => {
    $('#btnFinalizar').on('click', function () {
      Swal.fire({ title: "¿Se utilizó Materia prima extra?", showCancelButton: true, confirmButtonText: "Si", cancelButtonText: `No` })
        .then((result) => {
          if (result.isConfirmed) {
            $('#modalTitlemp').text("Agrega las materias primas extras utilizadas");
            $('#modalFormulariomp').modal();
          } else {
            finalizar();
          }
        });
    });
  }
  const editar = () => {
    $('#tbl').on('click', 'button[name="btn_editar"]', function () {
      Swal.fire({ title: "¿Deseas Gestionar este presupuesto?", showCancelButton: true, confirmButtonText: "Si", cancelButtonText: `No` })
        .then((result) => {
          if (result.isConfirmed) {
            $('#modalTitleg').text("Gestionar presupuesto");
            const idPres = $(this).data('idpresupuesto') ?? $(this).data('idorden');
            $('#txtidpresupuestog').val(idPres);

            fetch(`/api/v1/presupuestos/${idPres}`, { method: 'GET', headers: { 'Content-Type': 'application/json' } })
              .then(resp => resp.json())
              .then(data => {
                const d = data.data || {};
                $('#txtIdClienteg').val(d.cliente_id ?? d.idcliente ?? d.cliente ?? '');
                $('#txtClienteg').val(getClienteNombre(d));
                $('#modalFormulariog').modal();
                // Muestra los nuevos campos en el modal si lo deseas:

                return fetch(`/api/v1/presupuestos/${idPres}/detalles`, { method: 'GET', headers: { 'Content-Type': 'application/json' } });
              })
              .then(resp => { if (!resp.ok) throw new Error(resp.statusText); return resp.json(); })
              .then(detallesData => {
                const detalles = detallesData.data || [];
                const table = $("#detallesg tbody");
                table.empty();
                detalles.forEach(detalle => {
                  const { idcosto, pro_nombre, cos_prenda } = detalle;
                  console.log(detalle);
                  const newRow = $("<tr>");
                  $("<td>").text(pro_nombre ?? '').appendTo(newRow);
                  $("<td>").text(cos_prenda ?? '').addClass("costoProductoG").appendTo(newRow);
                  $("<td>").html('<button class="btn btn-link btn-delete-detalle"><i class="fa fa-trash"></i></button><input type="hidden" class="idcostoDetalle" value="' + idcosto + '">').appendTo(newRow);
                  table.append(newRow);
                });
                actualizarTotalGestion();
                $('#modalFormulariog').modal();
              })
              .catch(error => {
                console.error("Error al obtener los datos:", error);
                Swal.fire("Error", "No se pudo cargar el presupuesto. Intente nuevamente.", "error");
              });
          }
        });
    });
  }

  const eliminar = () => {
    $('#tbl').on('click', 'button[name="btn_eliminar"]', function () {
      const idCosto = $(this).data('idcosto');
      Swal.fire({ title: "¿Deseas eliminar este registro?", showCancelButton: true, confirmButtonText: "Si", cancelButtonText: `No` })
        .then((result) => {
          if (result.isConfirmed) {
            fetch(`/api/v1/costos/${idCosto}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } })
              .then(resp => resp.json())
              .then(data => {
                if (data && data.success) {
                  const fila = $(this).closest('tr');
                  const tabla = $('#tbl').DataTable();
                  tabla.row(fila).remove().draw();
                  Swal.fire("Eliminado", "", "success");
                } else {
                  Swal.fire(data.error || "Error al eliminar");
                }
              }).catch(err => {
                Swal.fire("Error", "Ocurrió un error al eliminar.", "error");
              });
          }
        });
    });
  }

  const formatearFecha = (fechaStr) => {
    if (!fechaStr) return '';
    const fecha = new Date(fechaStr);
    if (isNaN(fecha)) return fechaStr; // Si no es una fecha válida, muestra el original
    const dia = String(fecha.getDate()).padStart(2, '0');
    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
    const anio = fecha.getFullYear();
    const hora = String(fecha.getHours()).padStart(2, '0');
    const min = String(fecha.getMinutes()).padStart(2, '0');
    const seg = String(fecha.getSeconds()).padStart(2, '0');
    return `${dia}/${mes}/${anio} ${hora}:${min}:${seg}`;
  }

  // Agregar prenda en el modal de gestión
  $('#btnAgregarDetalleG').on('click', function () {
    $('#modal3Title').text("Selecciona una Prenda");
    $('#modalFormularioc').modal();

    $('#tblc').off('click', 'button[name="btn_asignar"]').on('click', 'button[name="btn_asignar"]', function () {
      const idcosto = $(this).data('id');
      const nombre = $(this).data('pnombre');
      fetch(`/api/v1/costos/${idcosto}`, { method: 'GET', headers: { 'Content-Type': 'application/json' } })
        .then(resp => resp.json())
        .then(data => {
          const totalProducto = data.data?.cos_total ?? 0;
          const table = $("#detallesg tbody");
          const newRow = $("<tr>");
          $("<td>").text(nombre ?? '').appendTo(newRow);
          $("<td>").text(totalProducto).addClass("costoProductoG").appendTo(newRow);
          $("<td>").html('<button class="btn btn-link btn-delete-detalle"><i class="fa fa-trash"></i></button><input type="hidden" class="idcostoDetalle" value="' + idcosto + '">').appendTo(newRow);
          table.append(newRow);
          actualizarTotalGestion();
          $('#modalFormularioc').modal('hide');
        });
    });
  });

  $('#btnAprobar').on('click', function () {
    const idPresupuesto = $('#txtidpresupuestog').val();
    fetch(`/api/v1/presupuestos/${idPresupuesto}/aprobar`, { method: 'POST' })
      .then(resp => resp.json())
      .then(data => {
        if (data.success) {
          Swal.fire("Aprobado", "El presupuesto fue aprobado y enviado a producción.", "success");
          $('#modalFormulariog').modal('hide');
          $('#tbl').DataTable().ajax.reload();
        } else {
          Swal.fire("Error", data.error || "No se pudo aprobar.");
        }
      });
  });

  $('#btnModificar').on('click', function () {
    const idPresupuesto = $('#txtidpresupuestog').val();
    const detalles = [];
    $("#detallesg tbody tr").each(function () {
      const idcosto = $(this).find(".idcostoDetalle").val();
      if (idcosto) detalles.push({ idcosto: idcosto });
    });
    const totalGeneral = parseFloat($("#totalGestionFooter").text()) || 0;
    fetch(`/api/v1/presupuestos/${idPresupuesto}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ detalles: detalles, total: totalGeneral })
    })
      .then(resp => resp.json())
      .then(data => {
        if (data.success) {
          Swal.fire("Modificado", "El presupuesto fue modificado.", "success");
          $('#modalFormulariog').modal('hide');
          $('#tbl').DataTable().ajax.reload();
        } else {
          Swal.fire("Error", data.error || "No se pudo modificar.");
        }
      });
  });

  $('#btnAnular').on('click', function () {
    const idPresupuesto = $('#txtidpresupuestog').val();
    fetch(`/api/v1/presupuestos/${idPresupuesto}/anular`, { method: 'POST' })
      .then(resp => resp.json())
      .then(data => {
        if (data.success) {
          Swal.fire("Anulado", "El presupuesto fue anulado.", "success");
          $('#modalFormulariog').modal('hide');
          $('#tbl').DataTable().ajax.reload();
        } else {
          Swal.fire("Error", data.error || "No se pudo anular.");
        }
      });
  });

  // Eliminar prenda en el modal de gestión
  $(document).on('click', '#detallesg .btn-delete-detalle', function () {
    $(this).closest("tr").remove();
    actualizarTotalGestion();
  });

  // Actualizar total en el modal de gestión
  function actualizarTotalGestion() {
    let total = 0;
    $("#detallesg tbody tr").each(function () {
      const costo = parseFloat($(this).find(".costoProductoG").text()) || 0;
      total += costo;
    });
    $("#totalGestionFooter").text(total.toFixed(2));
  }

  const addEvents = () => {
    agregar(); guardar(); editar(); eliminar();
    buacarcliente(); buacarcosto(); cargarDetalle();
    asignarprenda(); enviarArevision();
    cargarDetallempe(); buacarmat(); guardarmpe();
  }

  $(function () {
    initDatatable();
    initDatatableb();
    initDatatablem();
    initDatatablec();
    addEvents();
  });


</script>
{% endblock %}